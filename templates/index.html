<html>
	<head>

		<!-- jQuery -->
		<script type="text/javascript" src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
		<!-- socket IO -->
		<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/socket.io/1.3.6/socket.io.min.js"></script>

		<!-- leaflet (map) -->
		<link rel="stylesheet" href="https://unpkg.com/leaflet@1.4.0/dist/leaflet.css" integrity="sha512-puBpdR0798OZvTTbP4A8Ix/l+A4dHDD0DGqYW6RQ+9jxkRFclaxxQb/SJAWZfWAkuyeQUytO7+7N4QKrDh+drA==" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.4.0/dist/leaflet.js" integrity="sha512-QVftwZFqvtRNi0ZyCtsznlKSWOStnDORoefr1enyq5mVL4tmKB3S/EnC3rRJcxCPavG10IcrVGSmPh6Qw5lwrg==" crossorigin=""></script>
		<!-- leaflet geosearch -->
		<script src="https://unpkg.com/leaflet-geosearch@2.7.0/dist/bundle.min.js"></script>

		<link rel="stylesheet" href="/static/style.css"/>

	</head>
    <body>

			<div id="searcharea">
				<input type="text" placeholder="Enter city name" id="city">
				<input type="submit" value="Search city" id="citysubmit">

				<ul id="results">
				</ul>
			</div>
			
			<div id="mapid"></div>


			<script>

				// initialize the map on the "map" div with a given center and zoom
				var mymap = L.map('mapid').setView([50,0], 2);

				L.tileLayer('https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token={accessToken}', {
						attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors, <a href="https://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery Â© <a href="https://www.mapbox.com/">Mapbox</a>',
						maxZoom: 18,
						id: 'mapbox.streets',
						accessToken: 'pk.eyJ1IjoiZ2xociIsImEiOiJjanY5bWJzOWcxMzJsNDNzMWppb2pjODljIn0.wSf7rLO1Fl-GNK35Nb1CbA'
				}).addTo(mymap);

				// setup
				const provider = new window.GeoSearch.OpenStreetMapProvider();

				function getCoords(city) {
					return provider.search({ query: city })
					.then(data => {
							let result = data[0];
						
							if(result.raw.type == "city") {
								let x = parseFloat(result.raw.lat);
								let y = parseFloat(result.raw.lon);
								return [x,y];
							}
					});
				}

				function addCity(city) {
					coords = getCoords(city).then(
						coords => {
							console.log('Coords for ' + city + ': ' + coords);
							L.marker(coords).addTo(mymap);
						}
					);
				}

				var socket = io.connect('https://' + document.domain);

				$(document).ready(function() {

					socket.on('message', function(data) {
						console.log(data);
					})

					socket.on('newplace', function(data) {
						console.log('New place from backend: ' + data);
						addCity(data);
					})
				});

				function sendCity(city) {
					socket.emit('newplace',city);
				}

				function getSearch() {
					return $("#city").val();
				}

				function newSearch() {
					clearResults();
					search = getSearch();
					provider.search({ query: search })
					.then(results => {
							console.log('Search results: ' + JSON.stringify(results));
							jQuery.each(results, function (i, val) {
									$('#results').append('<li><button class="georesult">' +val.label+'</button></li>');
							});
					});
				}

				function resultSelected(selected) {
					console.log('Result selected:' + selected);
					clearResults();
					newCity(selected);
				}

				function newCity(city) {
					addCity(city);
					sendCity(city);
				}

				function clearResults() {
					$('#results').empty();
				}

				$("#citysubmit").on("click", newSearch);
				$(document).on("click", ".georesult", function() {
					resultSelected($(this).text())
				});
				
				
			</script>

    </body>
</html>
